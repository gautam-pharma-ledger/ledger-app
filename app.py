import streamlit as stimport pandas as pdfrom openai import OpenAIfrom datetime import datetimeimport jsonimport iofrom difflib import get_close_matchesfrom fpdf import FPDFimport gspreadfrom oauth2client.service_account import ServiceAccountCredentials
# --- CONFIG ---# We now get secrets from Streamlit Cloudtry:    api_key = st.secrets["OPENAI_API_KEY"]    client = OpenAI(api_key=api_key)except:    st.error("Secrets not found. Please configure secrets on Streamlit Cloud.")    st.stop()
# --- GOOGLE SHEETS CONNECTION ---def get_gsheet_client():    scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']    # Load credentials from Streamlit secrets    creds_dict = dict(st.secrets["gcp_service_account"])    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)    return gspread.authorize(creds)
def load_data(sheet_name):    """Reads a worksheet and returns a DataFrame"""    try:        client = get_gsheet_client()        sh = client.open("Gautam_Pharma_Ledger") # Name of your Google Sheet        worksheet = sh.worksheet(sheet_name)        data = worksheet.get_all_records()        return pd.DataFrame(data)    except Exception as e:        return pd.DataFrame()
def save_row_to_gsheet(sheet_name, row_dict):    """Appends a single row to the Google Sheet"""    client = get_gsheet_client()    sh = client.open("Gautam_Pharma_Ledger")    worksheet = sh.worksheet(sheet_name)    worksheet.append_row(list(row_dict.values()))
def update_party_balance_gsheet(party, amount):    """Updates the Balance sheet in cloud"""    client = get_gsheet_client()    sh = client.open("Gautam_Pharma_Ledger")    ws = sh.worksheet("Balances")        records = ws.get_all_records()    df = pd.DataFrame(records)        found = False    new_bal = amount        if not df.empty and "Party" in df.columns:        if party in df["Party"].values:            curr_bal = df.loc[df["Party"] == party, "Outstanding"].iloc[0]            try: curr_bal = float(curr_bal)            except: curr_bal = 0.0            new_bal = curr_bal + amount                        # Find row number (1-based index, +1 for header)            row_idx = df.index[df["Party"] == party].tolist()[0] + 2            ws.update_cell(row_idx, df.columns.get_loc("Outstanding") + 1, new_bal)            found = True                if not found:        ws.append_row([party, amount])
# --- HELPER FUNCTIONS ---def get_party_codes():    try:        df = load_data("Parties")        if df.empty: return pd.DataFrame(columns=["Code", "Type", "Name", "Phone", "Address", "Notes"])        for col in ["Phone", "Address", "Notes"]:             if col not in df.columns: df[col] = ""        return df.astype(str)    except:        return pd.DataFrame(columns=["Code", "Type", "Name", "Phone", "Address", "Notes"])
def get_next_code(party_type):    parties = get_party_codes()    if parties.empty: return "R1" if party_type == "Retailer" else "S1"        prefix = "R" if party_type == "Retailer" else "S"    codes = parties[parties["Type"] == party_type]["Code"].tolist()    nums = [int(c[1:]) for c in codes if str(c).startswith(prefix) and c[1:].isdigit()]    return f"{prefix}{max(nums) + 1 if nums else 1}"
def add_party_cloud(code, ptype, name, phone="", address=""):    save_row_to_gsheet("Parties", {        "Code": code, "Type": ptype, "Name": name,         "Phone": phone, "Address": address, "Notes": "Created via App"    })
# --- PDF GEN ---def generate_pdf_ledger(party_name, df_ledger, total_due):    pdf = FPDF()    pdf.add_page()    pdf.set_font("Arial", 'B', 16)    pdf.cell(190, 10, "Gautam Pharma - Party Ledger", ln=True, align='C')    pdf.set_font("Arial", '', 12)    pdf.cell(190, 10, f"Party: {party_name}", ln=True, align='L')    pdf.cell(190, 10, f"Date: {datetime.now().strftime('%Y-%m-%d')}", ln=True, align='L')    pdf.ln(10)    pdf.set_font("Arial", 'B', 10)    pdf.cell(30, 10, "Date", 1)    pdf.cell(80, 10, "Description", 1)    pdf.cell(30, 10, "Debit", 1)    pdf.cell(30, 10, "Credit", 1)    pdf.ln()    pdf.set_font("Arial", '', 10)    for _, row in df_ledger.iterrows():        dr = float(row['Debit']) if row['Debit'] else 0.0        cr = float(row['Credit']) if row['Credit'] else 0.0        pdf.cell(30, 10, str(row['Date']), 1)        pdf.cell(80, 10, str(row['Description'])[:35], 1)        pdf.cell(30, 10, f"{dr:.2f}", 1)        pdf.cell(30, 10, f"{cr:.2f}", 1)        pdf.ln()    pdf.ln(5)    pdf.set_font("Arial", 'B', 12)    pdf.cell(190, 10, f"Net Balance: Rs. {abs(total_due):,.2f}", ln=True)    return pdf.output(dest='S').encode('latin-1')
# --- APP UI ---st.set_page_config(page_title="Gautam Pharma Cloud", page_icon=" ", layout="wide")st.title(" Gautam Pharma Cloud Ledger")
tabs = st.tabs([" Manual Entry", " Parties", " Dashboard"])
# TAB 1: MANUAL ENTRYwith tabs[0]:    st.subheader("Add Transaction")    col1, col2 = st.columns(2)        with col1:        st.info("Customer (Retailer)")        with st.form("cust_form"):            parties = get_party_codes()            retailers = parties[parties["Type"] == "Retailer"]["Name"].tolist() if not parties.empty else []            name = st.selectbox("Select Customer", ["Select..."] + retailers)                        c_type = st.radio("Type", ["Sale (Due)", "Payment Received"])            amt = st.number_input("Amount", min_value=1.0)                        if st.form_submit_button("Save to Cloud"):                if name != "Select...":                    with st.spinner("Saving to Google Sheets..."):                        date = datetime.now().strftime("%Y-%m-%d")                        if c_type == "Sale (Due)":                            save_row_to_gsheet("CustomerDues", {"Date": date, "Party": name, "Amount": amt})                            update_party_balance_gsheet(name, amt)                        else:                            save_row_to_gsheet("PaymentsReceived", {"Date": date, "Party": name, "Amount": amt, "Mode": "Cash"})                            update_party_balance_gsheet(name, -amt)                        st.success(" Saved!")
# TAB 2: PARTIESwith tabs[1]:    st.subheader("Manage Parties")    with st.expander("Add New Party"):        c1, c2 = st.columns(2)        ptype = c1.selectbox("Type", ["Retailer", "Supplier"])        pname = c2.text_input("Name")        if st.button("Create Party"):            with st.spinner("Creating..."):                code = get_next_code(ptype)                add_party_cloud(code, ptype, pname)                st.success(f"Created {pname} ({code})")        if st.button("Refresh List"):        st.dataframe(get_party_codes(), use_container_width=True)
# TAB 3: DASHBOARDwith tabs[2]:    if st.button("Load Dashboard"):        with st.spinner("Fetching Data..."):            df_bal = load_data("Balances")            if not df_bal.empty:                df_bal["Outstanding"] = pd.to_numeric(df_bal["Outstanding"], errors='coerce').fillna(0)                total_rec = df_bal[df_bal["Outstanding"] > 0]["Outstanding"].sum()                st.metric("Total Market Dues", f"₹{total_rec:,.2f}")                st.dataframe(df_bal)            else:                st.warning("No data found.")